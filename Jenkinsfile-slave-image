#!groovy

def timestamp = java.time.Instant.now().toEpochMilli();

pipeline {
  agent any
  triggers {
    cron '@weekly'
  }
  stages {
    stage("Docker build and push") {
      agent { node { label 'linux-no-docker' } }
      steps {
          withCredentials([usernamePassword(credentialsId: 'DockerHubPwd', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
            //sh "docker login -u $USERNAME -p $PASSWORD"
            sh "ls -alrt /kaniko/.docker/"
            sh "/kaniko/executor --context `pwd`/slave-image/"
            // --destination jettyproject/jetty-build-agent:$timestamp"
            //sh "docker build --no-cache --tag=jetty-build-agent:latest slave-image/"
            //sh "docker tag jetty-build-agent:latest jettyproject/jetty-build-agent:$timestamp"
            //sh "docker push jettyproject/jetty-build-agent:$timestamp"
            //sh "docker logout"
            script {
              def imageName = Jenkins.instance.clouds.getByName("kubernetes").templates.find { it.name.equals("jenkins-slave") }.containers.find { it.name.equals("jnlp") }.image;
              echo "imageName before: $imageName"
              //Jenkins.instance.clouds.getByName("kubernetes").templates.find { it.name.equals("jenkins-slave") }.containers.find { it.name.equals("jnlp") }.image = "jettyproject/jetty-build-agent:" + timestamp
              //Jenkins.instance.save()
              imageName = Jenkins.instance.clouds.getByName("kubernetes").templates.find { it.name.equals("jenkins-slave") }.containers.find { it.name.equals("jnlp") }.image;
              echo "imageName after: $imageName"
            }
          }
      }
    }
  }
}
// vim: et:ts=2:sw=2:ft=groovy
